import { writeFileSync } from "fs";
import fetch from "node-fetch";
import { relative, resolve } from "path";

// Constants
const LANG_CODE_URL =
  "https://cloud.google.com/speech-to-text/docs/common/languages.json";
const DOC_COMMENT = `
/**
 * Language code
 * @remarks
 * See https://cloud.google.com/speech-to-text/docs/languages
 * @public 
 */`;
const OUTPUT_FILENAME = resolve(__dirname, "./output/LanguageCode.ts");
const TS_FILENAME = relative(resolve("."), __filename);

//  Types
/**
 * Language code record
 *
 * [Name, BCP-47 code, Model, ...other data]
 */
type Record = string[];

/** Full data received from GCP */
type Data = [Title[], ...Record[]];

// Interfaces
/** Title for language code records */
interface Title {
  label: string;
  value: string;
}

// Functions
/** Main function */
const main = async () => {
  // Fetch language code data
  const response = await fetch(LANG_CODE_URL);
  // Convert data to JSON
  const data = (await response.json()) as Data;
  // Get records without titles
  const records = data.slice(1) as Record[];
  // Get language codes from records
  const codes = records.map(record => record[1]);
  // Get unique codes
  const uniqueCodes = Array.from(new Set(codes));
  // Wrap codes in quotes
  const quotedCodes = uniqueCodes.map(code => `"${code}"`);
  // Join with pipes
  const typeSource = quotedCodes.join("|");
  // Create full text
  const text = `// Do not edit directly. Generated by ${TS_FILENAME}
  ${DOC_COMMENT}
  export type LanguageCode = ${typeSource};
  export const nothing = 0
  `;
  // Write to file
  writeFileSync(OUTPUT_FILENAME, text);
};

// Run
main().catch(console.error);
